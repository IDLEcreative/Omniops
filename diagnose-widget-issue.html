<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Diagnostic</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
    }
    #test-iframe {
      width: 100%;
      height: 600px;
      border: 2px solid #333;
      border-radius: 8px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <h1>üîç Chat Widget Diagnostic Tool</h1>

  <div class="test-section">
    <h2>Test 1: Direct Embed Page</h2>
    <p>Loading embed page directly in iframe:</p>
    <div id="test1-status" class="status info">‚è≥ Loading...</div>
    <iframe id="test-iframe" src="http://localhost:3000/embed?domain=localhost"></iframe>
  </div>

  <div class="test-section">
    <h2>Test 2: Embed Script Load</h2>
    <p>Testing if embed.js loads correctly:</p>
    <div id="test2-status" class="status info">‚è≥ Testing...</div>
  </div>

  <div class="test-section">
    <h2>Test 3: Client-Side Hydration</h2>
    <p>Checking if React is hydrating the widget:</p>
    <div id="test3-status" class="status info">‚è≥ Checking...</div>
  </div>

  <script>
    console.log('[DIAGNOSTIC] Page loaded');

    // Test 1: Check iframe loading
    const iframe = document.getElementById('test-iframe');
    const test1Status = document.getElementById('test1-status');

    iframe.onload = function() {
      console.log('[DIAGNOSTIC] Iframe loaded');
      test1Status.className = 'status success';
      test1Status.textContent = '‚úÖ Iframe loaded successfully';

      // Try to inspect iframe content
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const iframeBody = iframeDoc.body;
        console.log('[DIAGNOSTIC] Iframe body HTML length:', iframeBody.innerHTML.length);

        // Check if ChatWidget elements exist
        setTimeout(() => {
          const buttons = iframeDoc.querySelectorAll('button');
          const divs = iframeDoc.querySelectorAll('div');

          console.log('[DIAGNOSTIC] Buttons in iframe:', buttons.length);
          console.log('[DIAGNOSTIC] Divs in iframe:', divs.length);

          // Look for widget-specific elements
          const hasMessageCircle = iframeBody.innerHTML.includes('MessageCircle');
          const hasChat = iframeBody.innerHTML.toLowerCase().includes('chat');
          const hasButton = buttons.length > 0;

          const test3Status = document.getElementById('test3-status');
          if (hasButton) {
            test3Status.className = 'status success';
            test3Status.textContent = `‚úÖ Found ${buttons.length} button(s) - widget likely rendered`;
          } else {
            test3Status.className = 'status error';
            test3Status.textContent = '‚ùå No buttons found - widget NOT rendered';
            test3Status.textContent += `\nüìä Stats: ${divs.length} divs total`;
          }
        }, 2000); // Wait 2 seconds for React to hydrate
      } catch (err) {
        console.error('[DIAGNOSTIC] Cannot access iframe content (CORS):', err);
        test1Status.className = 'status error';
        test1Status.textContent = '‚ùå CORS error - cannot inspect iframe';
      }
    };

    iframe.onerror = function() {
      console.error('[DIAGNOSTIC] Iframe failed to load');
      test1Status.className = 'status error';
      test1Status.textContent = '‚ùå Failed to load iframe';
    };

    // Test 2: Check embed.js
    const test2Status = document.getElementById('test2-status');
    fetch('http://localhost:3000/embed.js')
      .then(response => {
        if (response.ok) {
          test2Status.className = 'status success';
          test2Status.textContent = '‚úÖ embed.js is accessible';
          return response.text();
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      })
      .then(scriptContent => {
        console.log('[DIAGNOSTIC] embed.js length:', scriptContent.length);
        const hasBottomRight = scriptContent.includes('bottom-right');
        if (hasBottomRight) {
          test2Status.textContent += '\n‚úÖ Contains bottom-right positioning';
        } else {
          test2Status.className = 'status error';
          test2Status.textContent += '\n‚ùå Missing bottom-right positioning';
        }
      })
      .catch(err => {
        console.error('[DIAGNOSTIC] embed.js error:', err);
        test2Status.className = 'status error';
        test2Status.textContent = `‚ùå Cannot load embed.js: ${err.message}`;
      });

    // Additional logging
    console.log('[DIAGNOSTIC] Test environment ready');
    console.log('[DIAGNOSTIC] Iframe URL:', iframe.src);
  </script>
</body>
</html>
