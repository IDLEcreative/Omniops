"use strict";(()=>{function C(t){return t&&t.includes("omniops.co.uk")&&!t.includes("www.omniops.co.uk")?t.replace("omniops.co.uk","www.omniops.co.uk"):t}var w={serverUrl:"https://www.omniops.co.uk",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function D(t,e){return{...t,...e||{}}}function P(t,e){return{...t,...e||{}}}function I(t,e){return{...t,...e||{}}}function U(t={}){let e={...t,serverUrl:t.serverUrl?C(t.serverUrl):void 0};return{...w,...e,appearance:D(w.appearance,t.appearance),behavior:P(w.behavior,t.behavior),features:I(w.features,t.features),privacy:{...w.privacy,...t.privacy||{}}}}function O(t,e,r={}){var i,a;if(!e)return{...t,serverUrl:C(t.serverUrl)};let o={...t,woocommerceEnabled:e.woocommerce_enabled||t.woocommerceEnabled};return o.appearance=D(D(o.appearance,e.appearance||void 0),r.appearance),o.behavior=P(P(o.behavior,e.behavior||void 0),r.behavior),o.features=I(I(o.features,e.features||void 0),r.features),e.domain&&(o.storeDomain=e.domain),e.branding&&(e.branding.primary_color&&!((i=r.appearance)!=null&&i.primaryColor)&&(o.appearance.primaryColor=e.branding.primary_color||o.appearance.primaryColor),e.branding.welcome_message&&!((a=r.behavior)!=null&&a.welcomeMessage)&&(o.behavior.welcomeMessage=e.branding.welcome_message||o.behavior.welcomeMessage)),o.serverUrl=C(o.serverUrl),o}function h(t){let e=(t||"").trim();if(!e)return[];let r=[],o=i=>{i&&!r.includes(i)&&r.push(i)};try{let i=new URL(e),a=i.hostname.replace(/^www\./,""),n=a==="localhost"||a==="127.0.0.1";if(!n&&!i.hostname.startsWith("www.")){let s=i.port?`:${i.port}`:"";o(`${i.protocol}//www.${a}${s}`)}if(o(i.origin),!n&&i.hostname.startsWith("www.")){let s=i.port?`:${i.port}`:"";o(`${i.protocol}//${a}${s}`)}}catch(i){let a=e.replace(/\/$/,"");o(a),a.includes("://")||o(`https://www.${a.replace(/^www\./,"")}`)}return r}async function L(t,e={},r){if(!r)return fetch(t,e);let o=new AbortController,i=setTimeout(()=>o.abort(),r);try{return await fetch(t,{...e,signal:o.signal})}finally{clearTimeout(i)}}async function v(t,e,r={}){var a,n;let o=(a=r.retryDelaysMs)!=null?a:[0],i=null;for(let s of t)for(let g of o){g&&await new Promise(d=>setTimeout(d,g));try{let d=await L(`${s}${e}`,r.init,(n=r.timeoutMs)!=null?n:8e3);if(!d.ok){i=new Error(`Request failed with status ${d.status}`);continue}return{data:r.parser?await r.parser(d):d,origin:s}}catch(d){i=d}}throw i instanceof Error?i:new Error("Failed to fetch from any candidate origin")}var y="chat_widget_privacy",x={optedOut:!1,consentGiven:!1};function b(){try{let t=localStorage.getItem(y);if(!t)return{...x};let e=JSON.parse(t);return{optedOut:!!(e!=null&&e.optedOut),consentGiven:!!(e!=null&&e.consentGiven)}}catch(t){return{...x}}}function u(t){try{localStorage.setItem(y,JSON.stringify(t))}catch(e){}}function _(t,e){var i,a;let r=document.createElement("iframe");r.id="chat-widget-iframe",r.title="Customer Support Chat",r.setAttribute("scrolling","no");let o=["position: fixed",e?"bottom: 0":(i=t.appearance.position)!=null&&i.includes("bottom")?"bottom: 20px":"top: 20px",e?"right: 0":(a=t.appearance.position)!=null&&a.includes("right")?"right: 20px":"left: 20px",e?"left: 0":"","border: none",`width: ${e?"100vw":(t.appearance.width||400)+"px"}`,`height: ${e?"100vh":(t.appearance.height||600)+"px"}`,`max-width: ${e?"100vw":"calc(100vw - 40px)"}`,`max-height: ${e?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${e?"0":t.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return r.style.cssText=`${o.join("; ")};`,r.style.display="none",r.style.pointerEvents="none",r}function E(t,e,r,o,i){(window.ChatWidgetDebug||t.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(r==null?void 0:r.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(r==null?void 0:r.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",o));let a={...t,domain:o,demoId:i,privacySettings:{allowOptOut:t.privacy.allowOptOut,showPrivacyNotice:t.privacy.showPrivacyNotice,requireConsent:t.privacy.requireConsent,consentGiven:e.consentGiven,retentionDays:t.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(a)};`,r,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||t.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function F(t){let{iframe:e,privacyPrefs:r,config:o}=t,i={optOut:()=>{u({...r,optedOut:!0}),e.remove()},optIn:()=>{u({...r,optedOut:!1})},giveConsent:()=>u({...r,consentGiven:!0}),requestDataExport:n=>{n!=null&&n.userId&&window.open(`${o.serverUrl}/privacy/export?user=${n.userId}`,"_blank")},requestDataDeletion:n=>{n!=null&&n.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${o.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n.userId})})}},a={resize:n=>{typeof(n==null?void 0:n.width)=="number"&&(e.style.width=`${n.width}px`),typeof(n==null?void 0:n.height)=="number"&&(e.style.height=`${n.height}px`)},widgetOpened:()=>{e.style.pointerEvents="auto"},widgetClosed:()=>{e.style.pointerEvents="none"},analytics:n=>{!r.optedOut&&typeof window.gtag=="function"&&(n!=null&&n.event)&&window.gtag("event",n.event,{event_category:"Chat Widget",event_label:n.label,value:n.value})},privacy:n=>{let s=n==null?void 0:n.action;s&&i[s]&&i[s](n)},ready:()=>{(o.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:n=>{n!=null&&n.message&&console.error("[Chat Widget] Widget error:",n.message)}};window.addEventListener("message",n=>{let s=n.data;if(!s||typeof s.type!="string")return;let g=a[s.type];g&&g(s)})}function R(t,e,r,o){let i=t.serverUrl||window.location.origin;window.ChatWidget={open(){var a;(a=e.contentWindow)==null||a.postMessage({type:"open"},i)},close(){var a;(a=e.contentWindow)==null||a.postMessage({type:"close"},i)},sendMessage(a){var n;(n=e.contentWindow)==null||n.postMessage({type:"message",message:a},i)},updateContext(a){var n;(n=e.contentWindow)==null||n.postMessage({type:"updateContext",userData:a==null?void 0:a.userData,cartData:a==null?void 0:a.cartData,pageContext:a==null?void 0:a.pageContext},i)},privacy:{optOut(){u({...r,optedOut:!0}),e.remove()},optIn(){u({...r,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(y),sessionStorage.clear()},getStatus(){return b()}},version:o}}var $="2.2.1762173741",T="chat_widget_last_cleanup";function c(t,e){window.ChatWidgetDebug&&console.debug("[Chat Widget]",t,e||"")}function f(t,e){window.ChatWidgetDebug&&console.error("[Chat Widget]",t,e||"")}function A(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function k(t,e){let r=window.location.hostname;if(r&&r!==""&&r!=="localhost")return c("Domain resolved from window.location.hostname",r),r;if(e.domain)return c("Domain resolved from userConfig.domain",e.domain),e.domain;if(e.storeDomain)return c("Domain resolved from userConfig.storeDomain",e.storeDomain),e.storeDomain;if(t.domain)return c("Domain resolved from config.domain",t.domain),t.domain;if(t.storeDomain)return c("Domain resolved from config.storeDomain",t.storeDomain),t.storeDomain;try{if(document.referrer){let o=new URL(document.referrer).hostname;if(o&&o!==""&&o!=="localhost")return c("Domain resolved from document.referrer",o),o}}catch(o){f("Unable to parse referrer for domain resolution",o)}try{if(window.parent&&window.parent!==window){let o=window.parent.location.hostname;if(o&&o!==""&&o!=="localhost")return c("Domain resolved from parent window",o),o}}catch(o){c("Unable to access parent window (likely cross-origin)",o)}return f("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:t.domain||t.storeDomain,userConfigDomain:e.domain||e.storeDomain}),null}async function N(t,e,r){let o=h(t.serverUrl);if(!o.length)return c("No server URL candidates available for remote config"),t;if(!e)return c("No domain resolved - skipping remote config fetch (will use defaults)"),t;try{let i=new URLSearchParams({domain:e}),{data:a,origin:n}=await v(o,`/api/widget/config?${i.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(a!=null&&a.success&&a.config){let s=O(t,a.config,r);return s.serverUrl=n,c("Loaded remote widget config",a.config),s}}catch(i){f("Remote config fetch failed",i)}return t}async function B(t){var o,i;let e=h(t.serverUrl);if(c("[Bundle Load] Candidates:",e),!e.length)throw new Error("No server URL candidates were provided");let r=await v(e,`/widget-bundle.js?v=${$}`,{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:a=>a.text()});return c("[Bundle Load] Fetched from:",r.origin),c("[Bundle Load] Code length:",((o=r.data)==null?void 0:o.length)||0),c("[Bundle Load] Code preview:",((i=r.data)==null?void 0:i.substring(0,100))||"EMPTY"),{code:r.data,origin:r.origin}}function H(t,e){var n;if(!t.privacy.retentionDays)return;let r=localStorage.getItem(T),o=Date.now(),i=1440*60*1e3,a=r?Number(r):0;(!a||o-a>i)&&((n=e.contentWindow)==null||n.postMessage({type:"cleanup",retentionDays:t.privacy.retentionDays},t.serverUrl||window.location.origin),localStorage.setItem(T,String(o)))}async function M(){try{let t=window.ChatWidgetConfig||{},e=U(t);if(!e.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}if(document.getElementById("chat-widget-iframe")){f("Widget already loaded");return}let r=b();if(r.optedOut&&e.privacy.allowOptOut){c("User has opted out of the widget");return}let o=k(e,t);o&&!e.storeDomain&&(e.storeDomain=o);let i=document.currentScript||document.querySelector('script[src*="embed.js"]'),a=i==null?void 0:i.getAttribute("data-demo");if(!t.skipRemoteConfig){let p=t.appId||(i==null?void 0:i.getAttribute("data-app-id"));if(p){c("[Initialize] Loading config by app_id:",p);try{let W=h(e.serverUrl),{data:m}=await v(W,`/api/widget/config?id=${encodeURIComponent(p)}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:S=>S.json()});m!=null&&m.success&&m.config&&(e=O(e,m.config,t),c("[Initialize] Config loaded successfully by app_id"))}catch(W){f("[Initialize] Failed to load config by app_id",W)}}else o?e=await N(e,o,t):c("Skipping remote config fetch; neither app_id nor domain available")}let n=e.storeDomain||o||"";!e.storeDomain&&n&&(e.storeDomain=n);let{code:s,origin:g}=await B(e);c("[Initialize] Bundle loaded from:",g),c("[Initialize] API calls will go to:",e.serverUrl),c("[Initialize] Bundle code length:",(s==null?void 0:s.length)||0),c("[Initialize] Creating iframe with bundle...");let d=_(e,A()),l=E(e,r,s,n,a||null);c("[Initialize] Generated iframe HTML length:",(l==null?void 0:l.length)||0),c("[Initialize] Bundle in HTML?",l!=null&&l.includes("OmniopsWidget")?"YES":"NO"),d.srcdoc=l,document.body.appendChild(d),d.onload=()=>{d.style.display="block",setTimeout(()=>{var p;(p=d.contentWindow)==null||p.postMessage({type:"init",config:e,privacyPrefs:r},e.serverUrl||window.location.origin)},100)},F({iframe:d,privacyPrefs:r,config:e}),R(e,d,r,$),H(e,d)}catch(t){f("Failed to initialize chat widget",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M,{once:!0}):M();})();
