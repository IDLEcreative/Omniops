"use strict";(()=>{function x(o){return o&&o.includes("omniops.co.uk")&&!o.includes("www.omniops.co.uk")?o.replace("omniops.co.uk","www.omniops.co.uk"):o}var v={serverUrl:"https://www.omniops.co.uk",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function E(o,t){return{...o,...t||{}}}function O(o,t){return{...o,...t||{}}}function k(o,t){return{...o,...t||{}}}function L(o={}){let t={...o,serverUrl:o.serverUrl?x(o.serverUrl):void 0};return{...v,...t,appearance:E(v.appearance,o.appearance),behavior:O(v.behavior,o.behavior),features:k(v.features,o.features),privacy:{...v.privacy,...o.privacy||{}}}}function I(o,t,r={}){var a,n;if(!t)return{...o,serverUrl:x(o.serverUrl)};let i={...o,woocommerceEnabled:t.woocommerce_enabled||o.woocommerceEnabled};return i.appearance=E(E(i.appearance,t.appearance||void 0),r.appearance),i.behavior=O(O(i.behavior,t.behavior||void 0),r.behavior),i.features=k(k(i.features,t.features||void 0),r.features),t.domain&&(i.storeDomain=t.domain),t.branding&&(t.branding.primary_color&&!((a=r.appearance)!=null&&a.primaryColor)&&(i.appearance.primaryColor=t.branding.primary_color||i.appearance.primaryColor),t.branding.welcome_message&&!((n=r.behavior)!=null&&n.welcomeMessage)&&(i.behavior.welcomeMessage=t.branding.welcome_message||i.behavior.welcomeMessage)),i.serverUrl=x(i.serverUrl),i}var D="chat_widget_privacy",A={optedOut:!1,consentGiven:!1};function P(){try{let o=localStorage.getItem(D);if(!o)return{...A};let t=JSON.parse(o);return{optedOut:!!(t!=null&&t.optedOut),consentGiven:!!(t!=null&&t.consentGiven)}}catch(o){return{...A}}}function y(o){try{localStorage.setItem(D,JSON.stringify(o))}catch(t){}}function T(o,t){var s,g,d;let r=document.createElement("iframe");r.id="chat-widget-iframe",r.title="Customer Support Chat",r.setAttribute("scrolling","no");let i=(s=o.appearance.startMinimized)!=null?s:!0,a=i&&!t?64:o.appearance.width||400,n=i&&!t?64:o.appearance.height||600,e=["position: fixed",t?"bottom: 0":(g=o.appearance.position)!=null&&g.includes("bottom")?"bottom: 20px":"top: 20px",t?"right: 0":(d=o.appearance.position)!=null&&d.includes("right")?"right: 20px":"left: 20px",t?"left: 0":"","border: none",`width: ${t?"100vw":a+"px"}`,`height: ${t?"100vh":n+"px"}`,`max-width: ${t?"100vw":"calc(100vw - 40px)"}`,`max-height: ${t?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${t||i?"0":o.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return r.style.cssText=`${e.join("; ")};`,r.style.display="none",r.style.pointerEvents="none",r}function M(o,t,r,i,a){(window.ChatWidgetDebug||o.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(r==null?void 0:r.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(r==null?void 0:r.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",i));let n={...o,domain:i,demoId:a,privacySettings:{allowOptOut:o.privacy.allowOptOut,showPrivacyNotice:o.privacy.showPrivacyNotice,requireConsent:o.privacy.requireConsent,consentGiven:t.consentGiven,retentionDays:o.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(n)};`,r,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||o.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function $(o){let{iframe:t,privacyPrefs:r,config:i}=o,a={optOut:()=>{y({...r,optedOut:!0}),t.remove()},optIn:()=>{y({...r,optedOut:!1})},giveConsent:()=>y({...r,consentGiven:!0}),requestDataExport:e=>{e!=null&&e.userId&&window.open(`${i.serverUrl}/privacy/export?user=${e.userId}`,"_blank")},requestDataDeletion:e=>{e!=null&&e.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${i.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e.userId})})}},n={ping:e=>{var s;e!=null&&e.pingTime&&((s=t.contentWindow)==null||s.postMessage({type:"pong",pingTime:e.pingTime},i.serverUrl||"*"))},resize:e=>{typeof(e==null?void 0:e.width)=="number"&&(t.style.width=`${e.width}px`),typeof(e==null?void 0:e.height)=="number"&&(t.style.height=`${e.height}px`)},widgetOpened:()=>{t.style.pointerEvents="auto"},widgetClosed:()=>{t.style.pointerEvents="none"},saveToParentStorage:e=>{if(e!=null&&e.key&&(e==null?void 0:e.value)!==void 0)try{localStorage.setItem(`chat_widget_${e.key}`,e.value),(i.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Saved to parent localStorage:",e.key,e.value)}catch(s){console.error("[Chat Widget] Failed to save to parent localStorage:",s)}},getFromParentStorage:e=>{var s,g;if(e!=null&&e.key&&(e!=null&&e.requestId))try{let d=localStorage.getItem(`chat_widget_${e.key}`);(s=t.contentWindow)==null||s.postMessage({type:"storageResponse",requestId:e.requestId,key:e.key,value:d},i.serverUrl||"*"),(i.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Retrieved from parent localStorage:",e.key,d)}catch(d){console.error("[Chat Widget] Failed to read from parent localStorage:",d),(g=t.contentWindow)==null||g.postMessage({type:"storageResponse",requestId:e.requestId,key:e.key,value:null},i.serverUrl||"*")}},removeFromParentStorage:e=>{if(e!=null&&e.key)try{localStorage.removeItem(`chat_widget_${e.key}`),(i.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Removed from parent localStorage:",e.key)}catch(s){console.error("[Chat Widget] Failed to remove from parent localStorage:",s)}},analytics:e=>{!r.optedOut&&typeof window.gtag=="function"&&(e!=null&&e.event)&&window.gtag("event",e.event,{event_category:"Chat Widget",event_label:e.label,value:e.value})},privacy:e=>{let s=e==null?void 0:e.action;s&&a[s]&&a[s](e)},ready:()=>{(i.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:e=>{e!=null&&e.message&&console.error("[Chat Widget] Widget error:",e.message)}};window.addEventListener("message",e=>{let s=window.location.origin,g=i.serverUrl?new URL(i.serverUrl).origin:s;if(!(e.origin===s||e.origin===g)){console.warn("[ChatWidget] Blocked message from untrusted origin:",e.origin);return}let u=e.data;if(!u||typeof u.type!="string")return;let f=n[u.type];f&&f(u)})}function z(o,t,r,i){let a=o.serverUrl||window.location.origin;window.ChatWidget={open(){var n;(n=t.contentWindow)==null||n.postMessage({type:"open"},a)},close(){var n;(n=t.contentWindow)==null||n.postMessage({type:"close"},a)},sendMessage(n){var e;(e=t.contentWindow)==null||e.postMessage({type:"message",message:n},a)},updateContext(n){var e;(e=t.contentWindow)==null||e.postMessage({type:"updateContext",userData:n==null?void 0:n.userData,cartData:n==null?void 0:n.cartData,pageContext:n==null?void 0:n.pageContext},a)},privacy:{optOut(){y({...r,optedOut:!0}),t.remove()},optIn(){y({...r,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(D),sessionStorage.clear()},getStatus(){return P()}},version:i}}var R="2.2.1762858727",B="chat_widget_last_cleanup";function l(o,t){window.ChatWidgetDebug&&console.debug("[Chat Widget]",o,t||"")}function h(o,t){window.ChatWidgetDebug&&console.error("[Chat Widget]",o,t||"")}function N(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function H(o,t){let r=window.location.hostname;if(r&&r!==""&&r!=="localhost")return l("Domain resolved from window.location.hostname",r),r;if(t.domain)return l("Domain resolved from userConfig.domain",t.domain),t.domain;if(t.storeDomain)return l("Domain resolved from userConfig.storeDomain",t.storeDomain),t.storeDomain;if(o.domain)return l("Domain resolved from config.domain",o.domain),o.domain;if(o.storeDomain)return l("Domain resolved from config.storeDomain",o.storeDomain),o.storeDomain;try{if(document.referrer){let i=new URL(document.referrer).hostname;if(i&&i!==""&&i!=="localhost")return l("Domain resolved from document.referrer",i),i}}catch(i){h("Unable to parse referrer for domain resolution",i)}try{if(window.parent&&window.parent!==window){let i=window.parent.location.hostname;if(i&&i!==""&&i!=="localhost")return l("Domain resolved from parent window",i),i}}catch(i){l("Unable to access parent window (likely cross-origin)",i)}return h("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:o.domain||o.storeDomain,userConfigDomain:t.domain||t.storeDomain}),null}function q(o,t,r){var s;if(!o.privacy.retentionDays)return;let i=localStorage.getItem(r),a=Date.now(),n=1440*60*1e3,e=i?Number(i):0;(!e||a-e>n)&&((s=t.contentWindow)==null||s.postMessage({type:"cleanup",retentionDays:o.privacy.retentionDays},o.serverUrl||window.location.origin),localStorage.setItem(r,String(a)))}function _(o){let t=(o||"").trim();if(!t)return[];let r=[],i=a=>{a&&!r.includes(a)&&r.push(a)};try{let a=new URL(t),n=a.hostname.replace(/^www\./,""),e=n==="localhost"||n==="127.0.0.1";if(!e&&!a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";i(`${a.protocol}//www.${n}${s}`)}if(i(a.origin),!e&&a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";i(`${a.protocol}//${n}${s}`)}}catch(a){let n=t.replace(/\/$/,"");i(n),n.includes("://")||i(`https://www.${n.replace(/^www\./,"")}`)}return r}async function X(o,t={},r){if(!r)return fetch(o,t);let i=new AbortController,a=setTimeout(()=>i.abort(),r);try{return await fetch(o,{...t,signal:i.signal})}finally{clearTimeout(a)}}async function S(o,t,r={}){var n,e;let i=(n=r.retryDelaysMs)!=null?n:[0],a=null;for(let s of o)for(let g of i){g&&await new Promise(d=>setTimeout(d,g));try{let d=await X(`${s}${t}`,r.init,(e=r.timeoutMs)!=null?e:8e3);if(!d.ok){a=new Error(`Request failed with status ${d.status}`);continue}return{data:r.parser?await r.parser(d):d,origin:s}}catch(d){a=d}}throw a instanceof Error?a:new Error("Failed to fetch from any candidate origin")}async function G(o,t,r){let i=_(o.serverUrl);if(!i.length)return l("No server URL candidates available for remote config"),o;if(!t)return l("No domain resolved - skipping remote config fetch (will use defaults)"),o;try{let a=new URLSearchParams({domain:t}),{data:n,origin:e}=await S(i,`/api/widget/config?${a.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(n!=null&&n.success&&n.config){let s=I(o,n.config,r);return s.serverUrl=e,l("Loaded remote widget config",n.config),s}}catch(a){h("Remote config fetch failed",a)}return o}async function Y(o,t){var a,n;let r=_(o.serverUrl);if(l("[Bundle Load] Candidates:",r),!r.length)throw new Error("No server URL candidates were provided");let i=await S(r,`/widget-bundle.js?v=${t}`,{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:e=>e.text()});return l("[Bundle Load] Fetched from:",i.origin),l("[Bundle Load] Code length:",((a=i.data)==null?void 0:a.length)||0),l("[Bundle Load] Code preview:",((n=i.data)==null?void 0:n.substring(0,100))||"EMPTY"),{code:i.data,origin:i.origin}}async function j(o,t){try{let r=_(o.serverUrl),{data:i}=await S(r,`/api/widget/config?id=${encodeURIComponent(t)}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:a=>a.json()});if(i!=null&&i.success&&i.config)return l("[Initialize] Config loaded successfully by app_id"),i.config}catch(r){h("[Initialize] Failed to load config by app_id",r)}return null}async function J(){var t,r,i;if(console.log("[Chat Widget] Initialize function called"),document.querySelector('[data-widget-init-lock="true"]')){l("Widget initialization already in progress (DOM lock detected), skipping");return}if(window._widgetInitializing){l("Widget initialization already in progress (JS flag), skipping");return}try{let a=window.ChatWidgetConfig||{};console.log("[Chat Widget] User config:",a);let n=L(a);if(console.log("[Chat Widget] Created config:",n),!n.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}console.log("[Chat Widget] serverUrl configured:",n.serverUrl);let e=document.getElementById("chat-widget-iframe");if(e){let c=!e.hasAttribute("data-ready"),p=localStorage.getItem("omniops_ui_language"),C=JSON.stringify({domain:n.domain,serverUrl:n.serverUrl,language:p}),b=window._lastWidgetConfig;if(c||C!==b)console.log("[Widget] Reinitializing - page reload or config change detected"),e.remove(),delete window._lastWidgetConfig,delete window._widgetInitializing;else{l("Widget already loaded with identical config, skipping initialization");return}}let s=document.createElement("meta");s.setAttribute("data-widget-init-lock","true"),s.setAttribute("id","widget-init-lock"),document.head.appendChild(s),window._widgetInitializing=!0;let g=localStorage.getItem("omniops_ui_language");if(!g){let c=navigator.language||((t=navigator.languages)==null?void 0:t[0])||"en",p=c.substring(0,2).toLowerCase();console.log(`[Chat Widget] Detected browser locale: ${c}, using language: ${p}`),localStorage.setItem("omniops_ui_language",p),g=p}window._lastWidgetConfig=JSON.stringify({domain:n.domain,serverUrl:n.serverUrl,language:g});let d=P();if(d.optedOut&&n.privacy.allowOptOut){l("User has opted out of the widget");return}let u=H(n,a);u&&!n.storeDomain&&(n.storeDomain=u);let f=document.currentScript||document.querySelector('script[src*="embed.js"]'),V=f==null?void 0:f.getAttribute("data-demo");if(!a.skipRemoteConfig){let c=a.appId||(f==null?void 0:f.getAttribute("data-app-id"));if(c){l("[Initialize] Loading config by app_id:",c);let p=await j(n,c);p&&(n=I(n,p,a))}else u?n=await G(n,u,a):l("Skipping remote config fetch; neither app_id nor domain available")}let U=n.storeDomain||u||"";!n.storeDomain&&U&&(n.storeDomain=U);let{code:W,origin:K}=await Y(n,R);l("[Initialize] Bundle loaded from:",K),l("[Initialize] API calls will go to:",n.serverUrl),l("[Initialize] Bundle code length:",(W==null?void 0:W.length)||0),l("[Initialize] Creating iframe with bundle...");let m=T(n,N()),w=M(n,d,W,U,V||null);l("[Initialize] Generated iframe HTML length:",(w==null?void 0:w.length)||0),l("[Initialize] Bundle in HTML?",w!=null&&w.includes("OmniopsWidget")?"YES":"NO"),m.srcdoc=w;let Q=navigator.language||((r=navigator.languages)==null?void 0:r[0])||"en";m.setAttribute("data-locale",Q),document.body.appendChild(m),m.onload=()=>{m.style.display="block",setTimeout(()=>{var b,F;let c=localStorage.getItem("chat_widget_session_id"),p=localStorage.getItem("chat_widget_conversation_id"),C=localStorage.getItem("chat_widget_widget_open");(n.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initializing with stored data:",{session_id:c,conversation_id:p,widget_open:C}),(b=m.contentWindow)==null||b.postMessage({type:"init",config:n,privacyPrefs:d,storedData:{sessionId:c,conversationId:p,widgetOpen:C==="true"}},n.serverUrl||window.location.origin),m.setAttribute("data-ready","true"),window.dispatchEvent(new CustomEvent("widget-ready",{detail:{language:g||"en"}})),(n.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initialization complete, widget ready for interaction"),(F=document.getElementById("widget-init-lock"))==null||F.remove(),window._widgetInitializing=!1},100)},$({iframe:m,privacyPrefs:d,config:n}),z(n,m,d,R),q(n,m,B),window.addEventListener("beforeunload",()=>{var p;let c=document.getElementById("chat-widget-iframe");c&&c.removeAttribute("data-ready"),delete window._lastWidgetConfig,delete window._widgetInitializing,(p=document.getElementById("widget-init-lock"))==null||p.remove()})}catch(a){h("Failed to initialize chat widget",a),(i=document.getElementById("widget-init-lock"))==null||i.remove(),window._widgetInitializing=!1}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J,{once:!0}):J();})();
