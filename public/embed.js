"use strict";(()=>{var p={serverUrl:"",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function w(r,e){return{...r,...e||{}}}function y(r,e){return{...r,...e||{}}}function v(r,e){return{...r,...e||{}}}function D(r={}){return{...p,...r,appearance:w(p.appearance,r.appearance),behavior:y(p.behavior,r.behavior),features:v(p.features,r.features),privacy:{...p.privacy,...r.privacy||{}}}}function P(r,e,t={}){var o,a;if(!e)return r;let n={...r,woocommerceEnabled:e.woocommerce_enabled||r.woocommerceEnabled};return n.appearance=w(w(n.appearance,e.appearance||void 0),t.appearance),n.behavior=y(y(n.behavior,e.behavior||void 0),t.behavior),n.features=v(v(n.features,e.features||void 0),t.features),e.domain&&(n.storeDomain=e.domain),e.branding&&(e.branding.primary_color&&!((o=t.appearance)!=null&&o.primaryColor)&&(n.appearance.primaryColor=e.branding.primary_color||n.appearance.primaryColor),e.branding.welcome_message&&!((a=t.behavior)!=null&&a.welcomeMessage)&&(n.behavior.welcomeMessage=e.branding.welcome_message||n.behavior.welcomeMessage)),n}function b(r){let e=(r||"").trim();if(!e)return[];let t=[],n=o=>{o&&!t.includes(o)&&t.push(o)};try{let o=new URL(e),a=o.hostname.replace(/^www\./,""),i=a==="localhost"||a==="127.0.0.1";if(!i&&!o.hostname.startsWith("www.")){let s=o.port?`:${o.port}`:"";n(`${o.protocol}//www.${a}${s}`)}if(n(o.origin),!i&&o.hostname.startsWith("www.")){let s=o.port?`:${o.port}`:"";n(`${o.protocol}//${a}${s}`)}}catch(o){let a=e.replace(/\/$/,"");n(a),a.includes("://")||n(`https://www.${a.replace(/^www\./,"")}`)}return t}async function R(r,e={},t){if(!t)return fetch(r,e);let n=new AbortController,o=setTimeout(()=>n.abort(),t);try{return await fetch(r,{...e,signal:n.signal})}finally{clearTimeout(o)}}async function W(r,e,t={}){var a,i;let n=(a=t.retryDelaysMs)!=null?a:[0],o=null;for(let s of r)for(let g of n){g&&await new Promise(d=>setTimeout(d,g));try{let d=await R(`${s}${e}`,t.init,(i=t.timeoutMs)!=null?i:8e3);if(!d.ok){o=new Error(`Request failed with status ${d.status}`);continue}return{data:t.parser?await t.parser(d):d,origin:s}}catch(d){o=d}}throw o instanceof Error?o:new Error("Failed to fetch from any candidate origin")}var m="chat_widget_privacy",I={optedOut:!1,consentGiven:!1};function h(){try{let r=localStorage.getItem(m);if(!r)return{...I};let e=JSON.parse(r);return{optedOut:!!(e!=null&&e.optedOut),consentGiven:!!(e!=null&&e.consentGiven)}}catch(r){return{...I}}}function u(r){try{localStorage.setItem(m,JSON.stringify(r))}catch(e){}}function x(r,e){var o,a;let t=document.createElement("iframe");t.id="chat-widget-iframe",t.title="Customer Support Chat",t.setAttribute("scrolling","no");let n=["position: fixed",e?"bottom: 0":(o=r.appearance.position)!=null&&o.includes("bottom")?"bottom: 20px":"top: 20px",e?"right: 0":(a=r.appearance.position)!=null&&a.includes("right")?"right: 20px":"left: 20px",e?"left: 0":"","border: none",`width: ${e?"100vw":(r.appearance.width||400)+"px"}`,`height: ${e?"100vh":(r.appearance.height||600)+"px"}`,`max-width: ${e?"100vw":"calc(100vw - 40px)"}`,`max-height: ${e?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${e?"0":r.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return t.style.cssText=`${n.join("; ")};`,t.style.display="none",t}function O(r,e,t,n,o){(window.ChatWidgetDebug||r.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(t==null?void 0:t.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(t==null?void 0:t.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",n));let a={...r,domain:n,demoId:o,privacySettings:{allowOptOut:r.privacy.allowOptOut,showPrivacyNotice:r.privacy.showPrivacyNotice,requireConsent:r.privacy.requireConsent,consentGiven:e.consentGiven,retentionDays:r.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(a)};`,t,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||r.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function E(r){let{iframe:e,privacyPrefs:t,config:n}=r,o={optOut:()=>{u({...t,optedOut:!0}),e.remove()},optIn:()=>{u({...t,optedOut:!1})},giveConsent:()=>u({...t,consentGiven:!0}),requestDataExport:i=>{i!=null&&i.userId&&window.open(`${n.serverUrl}/privacy/export?user=${i.userId}`,"_blank")},requestDataDeletion:i=>{i!=null&&i.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${n.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:i.userId})})}},a={resize:i=>{typeof(i==null?void 0:i.width)=="number"&&(e.style.width=`${i.width}px`),typeof(i==null?void 0:i.height)=="number"&&(e.style.height=`${i.height}px`)},analytics:i=>{!t.optedOut&&typeof window.gtag=="function"&&(i!=null&&i.event)&&window.gtag("event",i.event,{event_category:"Chat Widget",event_label:i.label,value:i.value})},privacy:i=>{let s=i==null?void 0:i.action;s&&o[s]&&o[s](i)},ready:()=>{(n.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:i=>{i!=null&&i.message&&console.error("[Chat Widget] Widget error:",i.message)}};window.addEventListener("message",i=>{let s=i.data;if(!s||typeof s.type!="string")return;let g=a[s.type];g&&g(s)})}function T(r,e,t,n){window.ChatWidget={open(){var o;(o=e.contentWindow)==null||o.postMessage({type:"open"},"*")},close(){var o;(o=e.contentWindow)==null||o.postMessage({type:"close"},"*")},sendMessage(o){var a;(a=e.contentWindow)==null||a.postMessage({type:"message",message:o},"*")},updateContext(o){var a;(a=e.contentWindow)==null||a.postMessage({type:"updateContext",userData:o==null?void 0:o.userData,cartData:o==null?void 0:o.cartData,pageContext:o==null?void 0:o.pageContext},"*")},privacy:{optOut(){u({...t,optedOut:!0}),e.remove()},optIn(){u({...t,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(m),sessionStorage.clear()},getStatus(){return h()}},version:n}}var M="2.1.0",F="chat_widget_last_cleanup";function c(r,e){window.ChatWidgetDebug&&console.debug("[Chat Widget]",r,e||"")}function f(r,e){window.ChatWidgetDebug&&console.error("[Chat Widget]",r,e||"")}function S(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function U(r,e){let t=window.location.hostname;if(t&&t!==""&&t!=="localhost")return c("Domain resolved from window.location.hostname",t),t;if(e.storeDomain)return c("Domain resolved from userConfig.storeDomain",e.storeDomain),e.storeDomain;if(r.storeDomain)return c("Domain resolved from config.storeDomain",r.storeDomain),r.storeDomain;try{if(document.referrer){let n=new URL(document.referrer).hostname;if(n&&n!==""&&n!=="localhost")return c("Domain resolved from document.referrer",n),n}}catch(n){f("Unable to parse referrer for domain resolution",n)}try{if(window.parent&&window.parent!==window){let n=window.parent.location.hostname;if(n&&n!==""&&n!=="localhost")return c("Domain resolved from parent window",n),n}}catch(n){c("Unable to access parent window (likely cross-origin)",n)}return f("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:r.storeDomain,userConfigDomain:e.storeDomain}),null}async function $(r,e,t){let n=b(r.serverUrl);if(!n.length)return c("No server URL candidates available for remote config"),r;if(!e)return c("No domain resolved - skipping remote config fetch (will use defaults)"),r;try{let o=new URLSearchParams({domain:e}),{data:a,origin:i}=await W(n,`/api/widget/config?${o.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(a!=null&&a.success&&a.config){let s=P(r,a.config,t);return s.serverUrl=i,c("Loaded remote widget config",a.config),s}}catch(o){f("Remote config fetch failed",o)}return r}async function L(r){var n,o;let e=b(r.serverUrl);if(c("[Bundle Load] Candidates:",e),!e.length)throw new Error("No server URL candidates were provided");let t=await W(e,"/widget-bundle.js",{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:a=>a.text()});return c("[Bundle Load] Fetched from:",t.origin),c("[Bundle Load] Code length:",((n=t.data)==null?void 0:n.length)||0),c("[Bundle Load] Code preview:",((o=t.data)==null?void 0:o.substring(0,100))||"EMPTY"),{code:t.data,origin:t.origin}}function A(r,e){var i;if(!r.privacy.retentionDays)return;let t=localStorage.getItem(F),n=Date.now(),o=1440*60*1e3,a=t?Number(t):0;(!a||n-a>o)&&((i=e.contentWindow)==null||i.postMessage({type:"cleanup",retentionDays:r.privacy.retentionDays},"*"),localStorage.setItem(F,String(n)))}async function _(){var r;try{let e=window.ChatWidgetConfig||{},t=D(e);if(!t.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}if(document.getElementById("chat-widget-iframe")){f("Widget already loaded");return}let n=h();if(n.optedOut&&t.privacy.allowOptOut){c("User has opted out of the widget");return}let o=U(t,e);o&&!t.storeDomain&&(t.storeDomain=o);let a=(r=document.currentScript||document.querySelector('script[src*="embed.js"]'))==null?void 0:r.getAttribute("data-demo");e.skipRemoteConfig||(o?t=await $(t,o,e):c("Skipping remote config fetch; domain could not be determined"));let i=t.storeDomain||o||"";!t.storeDomain&&i&&(t.storeDomain=i);let{code:s,origin:g}=await L(t);t.serverUrl=g,c("[Initialize] Bundle code length:",(s==null?void 0:s.length)||0),c("[Initialize] Creating iframe with bundle...");let d=x(t,S()),l=O(t,n,s,i,a||null);c("[Initialize] Generated iframe HTML length:",(l==null?void 0:l.length)||0),c("[Initialize] Bundle in HTML?",l!=null&&l.includes("OmniopsWidget")?"YES":"NO"),d.srcdoc=l,document.body.appendChild(d),d.onload=()=>{d.style.display="block",setTimeout(()=>{var C;(C=d.contentWindow)==null||C.postMessage({type:"init",config:t,privacyPrefs:n},"*")},100)},E({iframe:d,privacyPrefs:n,config:t}),T(t,d,n,M),A(t,d)}catch(e){f("Failed to initialize chat widget",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_,{once:!0}):_();})();
