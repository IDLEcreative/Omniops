"use strict";(()=>{function _(i){return i&&i.includes("omniops.co.uk")&&!i.includes("www.omniops.co.uk")?i.replace("omniops.co.uk","www.omniops.co.uk"):i}var v={serverUrl:"https://www.omniops.co.uk",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function U(i,o){return{...i,...o||{}}}function S(i,o){return{...i,...o||{}}}function x(i,o){return{...i,...o||{}}}function R(i={}){let o={...i,serverUrl:i.serverUrl?_(i.serverUrl):void 0};return{...v,...o,appearance:U(v.appearance,i.appearance),behavior:S(v.behavior,i.behavior),features:x(v.features,i.features),privacy:{...v.privacy,...i.privacy||{}}}}function C(i,o,n={}){var a,r;if(!o)return{...i,serverUrl:_(i.serverUrl)};let e={...i,woocommerceEnabled:o.woocommerce_enabled||i.woocommerceEnabled};return e.appearance=U(U(e.appearance,o.appearance||void 0),n.appearance),e.behavior=S(S(e.behavior,o.behavior||void 0),n.behavior),e.features=x(x(e.features,o.features||void 0),n.features),o.domain&&(e.storeDomain=o.domain),o.branding&&(o.branding.primary_color&&!((a=n.appearance)!=null&&a.primaryColor)&&(e.appearance.primaryColor=o.branding.primary_color||e.appearance.primaryColor),o.branding.welcome_message&&!((r=n.behavior)!=null&&r.welcomeMessage)&&(e.behavior.welcomeMessage=o.branding.welcome_message||e.behavior.welcomeMessage)),e.serverUrl=_(e.serverUrl),e}var b="chat_widget_privacy",k={optedOut:!1,consentGiven:!1};function I(){try{let i=localStorage.getItem(b);if(!i)return{...k};let o=JSON.parse(i);return{optedOut:!!(o!=null&&o.optedOut),consentGiven:!!(o!=null&&o.consentGiven)}}catch(i){return{...k}}}function y(i){try{localStorage.setItem(b,JSON.stringify(i))}catch(o){}}function L(i,o){var s,g,d;let n=document.createElement("iframe");n.id="chat-widget-iframe",n.title="Customer Support Chat",n.setAttribute("scrolling","no");let e=(s=i.appearance.startMinimized)!=null?s:!0,a=e&&!o?64:i.appearance.width||400,r=e&&!o?64:i.appearance.height||600,t=["position: fixed",o?"bottom: 0":(g=i.appearance.position)!=null&&g.includes("bottom")?"bottom: 20px":"top: 20px",o?"right: 0":(d=i.appearance.position)!=null&&d.includes("right")?"right: 20px":"left: 20px",o?"left: 0":"","border: none",`width: ${o?"100vw":a+"px"}`,`height: ${o?"100vh":r+"px"}`,`max-width: ${o?"100vw":"calc(100vw - 40px)"}`,`max-height: ${o?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${o||e?"0":i.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return n.style.cssText=`${t.join("; ")};`,n.style.display="none",n.style.pointerEvents="none",n}function F(i,o,n,e,a){(window.ChatWidgetDebug||i.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(n==null?void 0:n.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(n==null?void 0:n.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",e));let r={...i,domain:e,demoId:a,privacySettings:{allowOptOut:i.privacy.allowOptOut,showPrivacyNotice:i.privacy.showPrivacyNotice,requireConsent:i.privacy.requireConsent,consentGiven:o.consentGiven,retentionDays:i.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(r)};`,n,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||i.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function T(i){let{iframe:o,privacyPrefs:n,config:e}=i,a={optOut:()=>{y({...n,optedOut:!0}),o.remove()},optIn:()=>{y({...n,optedOut:!1})},giveConsent:()=>y({...n,consentGiven:!0}),requestDataExport:t=>{t!=null&&t.userId&&window.open(`${e.serverUrl}/privacy/export?user=${t.userId}`,"_blank")},requestDataDeletion:t=>{t!=null&&t.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${e.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t.userId})})}},r={ping:t=>{var s;t!=null&&t.pingTime&&((s=o.contentWindow)==null||s.postMessage({type:"pong",pingTime:t.pingTime},e.serverUrl||"*"))},resize:t=>{typeof(t==null?void 0:t.width)=="number"&&(o.style.width=`${t.width}px`),typeof(t==null?void 0:t.height)=="number"&&(o.style.height=`${t.height}px`)},widgetOpened:()=>{o.style.pointerEvents="auto"},widgetClosed:()=>{o.style.pointerEvents="none"},saveToParentStorage:t=>{if(t!=null&&t.key&&(t==null?void 0:t.value)!==void 0)try{localStorage.setItem(`chat_widget_${t.key}`,t.value),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Saved to parent localStorage:",t.key,t.value)}catch(s){console.error("[Chat Widget] Failed to save to parent localStorage:",s)}},getFromParentStorage:t=>{var s,g;if(t!=null&&t.key&&(t!=null&&t.requestId))try{let d=localStorage.getItem(`chat_widget_${t.key}`);(s=o.contentWindow)==null||s.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:d},e.serverUrl||"*"),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Retrieved from parent localStorage:",t.key,d)}catch(d){console.error("[Chat Widget] Failed to read from parent localStorage:",d),(g=o.contentWindow)==null||g.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:null},e.serverUrl||"*")}},removeFromParentStorage:t=>{if(t!=null&&t.key)try{localStorage.removeItem(`chat_widget_${t.key}`),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Removed from parent localStorage:",t.key)}catch(s){console.error("[Chat Widget] Failed to remove from parent localStorage:",s)}},analytics:t=>{!n.optedOut&&typeof window.gtag=="function"&&(t!=null&&t.event)&&window.gtag("event",t.event,{event_category:"Chat Widget",event_label:t.label,value:t.value})},privacy:t=>{let s=t==null?void 0:t.action;s&&a[s]&&a[s](t)},ready:()=>{(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:t=>{t!=null&&t.message&&console.error("[Chat Widget] Widget error:",t.message)}};window.addEventListener("message",t=>{let s=window.location.origin,g=e.serverUrl?new URL(e.serverUrl).origin:s;if(!(t.origin===s||t.origin===g)){console.warn("[ChatWidget] Blocked message from untrusted origin:",t.origin);return}let f=t.data;if(!f||typeof f.type!="string")return;let m=r[f.type];m&&m(f)})}function $(i,o,n,e){let a=i.serverUrl||window.location.origin;window.ChatWidget={open(){var r;(r=o.contentWindow)==null||r.postMessage({type:"open"},a)},close(){var r;(r=o.contentWindow)==null||r.postMessage({type:"close"},a)},sendMessage(r){var t;(t=o.contentWindow)==null||t.postMessage({type:"message",message:r},a)},updateContext(r){var t;(t=o.contentWindow)==null||t.postMessage({type:"updateContext",userData:r==null?void 0:r.userData,cartData:r==null?void 0:r.cartData,pageContext:r==null?void 0:r.pageContext},a)},privacy:{optOut(){y({...n,optedOut:!0}),o.remove()},optIn(){y({...n,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(b),sessionStorage.clear()},getStatus(){return I()}},version:e}}var O="2.2.1762817116",M="chat_widget_last_cleanup";function l(i,o){window.ChatWidgetDebug&&console.debug("[Chat Widget]",i,o||"")}function h(i,o){window.ChatWidgetDebug&&console.error("[Chat Widget]",i,o||"")}function A(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function z(i,o){let n=window.location.hostname;if(n&&n!==""&&n!=="localhost")return l("Domain resolved from window.location.hostname",n),n;if(o.domain)return l("Domain resolved from userConfig.domain",o.domain),o.domain;if(o.storeDomain)return l("Domain resolved from userConfig.storeDomain",o.storeDomain),o.storeDomain;if(i.domain)return l("Domain resolved from config.domain",i.domain),i.domain;if(i.storeDomain)return l("Domain resolved from config.storeDomain",i.storeDomain),i.storeDomain;try{if(document.referrer){let e=new URL(document.referrer).hostname;if(e&&e!==""&&e!=="localhost")return l("Domain resolved from document.referrer",e),e}}catch(e){h("Unable to parse referrer for domain resolution",e)}try{if(window.parent&&window.parent!==window){let e=window.parent.location.hostname;if(e&&e!==""&&e!=="localhost")return l("Domain resolved from parent window",e),e}}catch(e){l("Unable to access parent window (likely cross-origin)",e)}return h("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:i.domain||i.storeDomain,userConfigDomain:o.domain||o.storeDomain}),null}function B(i,o,n){var s;if(!i.privacy.retentionDays)return;let e=localStorage.getItem(n),a=Date.now(),r=1440*60*1e3,t=e?Number(e):0;(!t||a-t>r)&&((s=o.contentWindow)==null||s.postMessage({type:"cleanup",retentionDays:i.privacy.retentionDays},i.serverUrl||window.location.origin),localStorage.setItem(n,String(a)))}function D(i){let o=(i||"").trim();if(!o)return[];let n=[],e=a=>{a&&!n.includes(a)&&n.push(a)};try{let a=new URL(o),r=a.hostname.replace(/^www\./,""),t=r==="localhost"||r==="127.0.0.1";if(!t&&!a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";e(`${a.protocol}//www.${r}${s}`)}if(e(a.origin),!t&&a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";e(`${a.protocol}//${r}${s}`)}}catch(a){let r=o.replace(/\/$/,"");e(r),r.includes("://")||e(`https://www.${r.replace(/^www\./,"")}`)}return n}async function V(i,o={},n){if(!n)return fetch(i,o);let e=new AbortController,a=setTimeout(()=>e.abort(),n);try{return await fetch(i,{...o,signal:e.signal})}finally{clearTimeout(a)}}async function P(i,o,n={}){var r,t;let e=(r=n.retryDelaysMs)!=null?r:[0],a=null;for(let s of i)for(let g of e){g&&await new Promise(d=>setTimeout(d,g));try{let d=await V(`${s}${o}`,n.init,(t=n.timeoutMs)!=null?t:8e3);if(!d.ok){a=new Error(`Request failed with status ${d.status}`);continue}return{data:n.parser?await n.parser(d):d,origin:s}}catch(d){a=d}}throw a instanceof Error?a:new Error("Failed to fetch from any candidate origin")}async function N(i,o,n){let e=D(i.serverUrl);if(!e.length)return l("No server URL candidates available for remote config"),i;if(!o)return l("No domain resolved - skipping remote config fetch (will use defaults)"),i;try{let a=new URLSearchParams({domain:o}),{data:r,origin:t}=await P(e,`/api/widget/config?${a.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(r!=null&&r.success&&r.config){let s=C(i,r.config,n);return s.serverUrl=t,l("Loaded remote widget config",r.config),s}}catch(a){h("Remote config fetch failed",a)}return i}async function H(i,o){var a,r;let n=D(i.serverUrl);if(l("[Bundle Load] Candidates:",n),!n.length)throw new Error("No server URL candidates were provided");let e=await P(n,`/widget-bundle.js?v=${o}`,{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:t=>t.text()});return l("[Bundle Load] Fetched from:",e.origin),l("[Bundle Load] Code length:",((a=e.data)==null?void 0:a.length)||0),l("[Bundle Load] Code preview:",((r=e.data)==null?void 0:r.substring(0,100))||"EMPTY"),{code:e.data,origin:e.origin}}async function q(i,o){try{let n=D(i.serverUrl),{data:e}=await P(n,`/api/widget/config?id=${encodeURIComponent(o)}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:a=>a.json()});if(e!=null&&e.success&&e.config)return l("[Initialize] Config loaded successfully by app_id"),e.config}catch(n){h("[Initialize] Failed to load config by app_id",n)}return null}async function G(){var i,o;if(console.log("[Chat Widget] Initialize function called"),window._widgetInitializing){l("Widget initialization already in progress, skipping");return}try{let n=window.ChatWidgetConfig||{};console.log("[Chat Widget] User config:",n);let e=R(n);if(console.log("[Chat Widget] Created config:",e),!e.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}console.log("[Chat Widget] serverUrl configured:",e.serverUrl);let a=document.getElementById("chat-widget-iframe");if(a){let c=localStorage.getItem("omniops_ui_language"),p=JSON.stringify({domain:e.domain,serverUrl:e.serverUrl,language:c}),W=window._lastWidgetConfig;if(p!==W)console.log("[Widget] Config changed, cleaning up previous instance"),a.remove(),delete window._lastWidgetConfig,delete window._widgetInitializing;else{l("Widget already loaded with identical config, skipping initialization");return}}window._widgetInitializing=!0;let r=localStorage.getItem("omniops_ui_language");if(!r){let c=navigator.language||((i=navigator.languages)==null?void 0:i[0])||"en",p=c.substring(0,2).toLowerCase();console.log(`[Chat Widget] Detected browser locale: ${c}, using language: ${p}`),localStorage.setItem("omniops_ui_language",p),r=p}window._lastWidgetConfig=JSON.stringify({domain:e.domain,serverUrl:e.serverUrl,language:r});let t=I();if(t.optedOut&&e.privacy.allowOptOut){l("User has opted out of the widget");return}let s=z(e,n);s&&!e.storeDomain&&(e.storeDomain=s);let g=document.currentScript||document.querySelector('script[src*="embed.js"]'),d=g==null?void 0:g.getAttribute("data-demo");if(!n.skipRemoteConfig){let c=n.appId||(g==null?void 0:g.getAttribute("data-app-id"));if(c){l("[Initialize] Loading config by app_id:",c);let p=await q(e,c);p&&(e=C(e,p,n))}else s?e=await N(e,s,n):l("Skipping remote config fetch; neither app_id nor domain available")}let f=e.storeDomain||s||"";!e.storeDomain&&f&&(e.storeDomain=f);let{code:m,origin:Y}=await H(e,O);l("[Initialize] Bundle loaded from:",Y),l("[Initialize] API calls will go to:",e.serverUrl),l("[Initialize] Bundle code length:",(m==null?void 0:m.length)||0),l("[Initialize] Creating iframe with bundle...");let u=L(e,A()),w=F(e,t,m,f,d||null);l("[Initialize] Generated iframe HTML length:",(w==null?void 0:w.length)||0),l("[Initialize] Bundle in HTML?",w!=null&&w.includes("OmniopsWidget")?"YES":"NO"),u.srcdoc=w;let j=navigator.language||((o=navigator.languages)==null?void 0:o[0])||"en";u.setAttribute("data-locale",j),document.body.appendChild(u),u.onload=()=>{u.style.display="block",setTimeout(()=>{var E;let c=localStorage.getItem("chat_widget_session_id"),p=localStorage.getItem("chat_widget_conversation_id"),W=localStorage.getItem("chat_widget_widget_open");(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initializing with stored data:",{session_id:c,conversation_id:p,widget_open:W}),(E=u.contentWindow)==null||E.postMessage({type:"init",config:e,privacyPrefs:t,storedData:{sessionId:c,conversationId:p,widgetOpen:W==="true"}},e.serverUrl||window.location.origin),u.setAttribute("data-ready","true"),window.dispatchEvent(new CustomEvent("widget-ready",{detail:{language:r||"en"}})),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initialization complete, widget ready for interaction"),window._widgetInitializing=!1},100)},T({iframe:u,privacyPrefs:t,config:e}),$(e,u,t,O),B(e,u,M),window.addEventListener("beforeunload",()=>{let c=document.getElementById("chat-widget-iframe");c&&c.removeAttribute("data-ready"),delete window._lastWidgetConfig,delete window._widgetInitializing})}catch(n){h("Failed to initialize chat widget",n),window._widgetInitializing=!1}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",G,{once:!0}):G();})();
