"use strict";(()=>{function _(r){return r&&r.includes("omniops.co.uk")&&!r.includes("www.omniops.co.uk")?r.replace("omniops.co.uk","www.omniops.co.uk"):r}var v={serverUrl:"https://www.omniops.co.uk",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function U(r,o){return{...r,...o||{}}}function S(r,o){return{...r,...o||{}}}function x(r,o){return{...r,...o||{}}}function R(r={}){let o={...r,serverUrl:r.serverUrl?_(r.serverUrl):void 0};return{...v,...o,appearance:U(v.appearance,r.appearance),behavior:S(v.behavior,r.behavior),features:x(v.features,r.features),privacy:{...v.privacy,...r.privacy||{}}}}function W(r,o,i={}){var a,n;if(!o)return{...r,serverUrl:_(r.serverUrl)};let e={...r,woocommerceEnabled:o.woocommerce_enabled||r.woocommerceEnabled};return e.appearance=U(U(e.appearance,o.appearance||void 0),i.appearance),e.behavior=S(S(e.behavior,o.behavior||void 0),i.behavior),e.features=x(x(e.features,o.features||void 0),i.features),o.domain&&(e.storeDomain=o.domain),o.branding&&(o.branding.primary_color&&!((a=i.appearance)!=null&&a.primaryColor)&&(e.appearance.primaryColor=o.branding.primary_color||e.appearance.primaryColor),o.branding.welcome_message&&!((n=i.behavior)!=null&&n.welcomeMessage)&&(e.behavior.welcomeMessage=o.branding.welcome_message||e.behavior.welcomeMessage)),e.serverUrl=_(e.serverUrl),e}var C="chat_widget_privacy",k={optedOut:!1,consentGiven:!1};function b(){try{let r=localStorage.getItem(C);if(!r)return{...k};let o=JSON.parse(r);return{optedOut:!!(o!=null&&o.optedOut),consentGiven:!!(o!=null&&o.consentGiven)}}catch(r){return{...k}}}function y(r){try{localStorage.setItem(C,JSON.stringify(r))}catch(o){}}function F(r,o){var s,g,c;let i=document.createElement("iframe");i.id="chat-widget-iframe",i.title="Customer Support Chat",i.setAttribute("scrolling","no");let e=(s=r.appearance.startMinimized)!=null?s:!0,a=e&&!o?64:r.appearance.width||400,n=e&&!o?64:r.appearance.height||600,t=["position: fixed",o?"bottom: 0":(g=r.appearance.position)!=null&&g.includes("bottom")?"bottom: 20px":"top: 20px",o?"right: 0":(c=r.appearance.position)!=null&&c.includes("right")?"right: 20px":"left: 20px",o?"left: 0":"","border: none",`width: ${o?"100vw":a+"px"}`,`height: ${o?"100vh":n+"px"}`,`max-width: ${o?"100vw":"calc(100vw - 40px)"}`,`max-height: ${o?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${o||e?"0":r.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return i.style.cssText=`${t.join("; ")};`,i.style.display="none",i.style.pointerEvents="none",i}function L(r,o,i,e,a){(window.ChatWidgetDebug||r.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(i==null?void 0:i.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(i==null?void 0:i.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",e));let n={...r,domain:e,demoId:a,privacySettings:{allowOptOut:r.privacy.allowOptOut,showPrivacyNotice:r.privacy.showPrivacyNotice,requireConsent:r.privacy.requireConsent,consentGiven:o.consentGiven,retentionDays:r.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(n)};`,i,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||r.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function T(r){let{iframe:o,privacyPrefs:i,config:e}=r,a={optOut:()=>{y({...i,optedOut:!0}),o.remove()},optIn:()=>{y({...i,optedOut:!1})},giveConsent:()=>y({...i,consentGiven:!0}),requestDataExport:t=>{t!=null&&t.userId&&window.open(`${e.serverUrl}/privacy/export?user=${t.userId}`,"_blank")},requestDataDeletion:t=>{t!=null&&t.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${e.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t.userId})})}},n={ping:t=>{var s;t!=null&&t.pingTime&&((s=o.contentWindow)==null||s.postMessage({type:"pong",pingTime:t.pingTime},e.serverUrl||"*"))},resize:t=>{typeof(t==null?void 0:t.width)=="number"&&(o.style.width=`${t.width}px`),typeof(t==null?void 0:t.height)=="number"&&(o.style.height=`${t.height}px`)},widgetOpened:()=>{o.style.pointerEvents="auto"},widgetClosed:()=>{o.style.pointerEvents="none"},saveToParentStorage:t=>{if(t!=null&&t.key&&(t==null?void 0:t.value)!==void 0)try{localStorage.setItem(`chat_widget_${t.key}`,t.value),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Saved to parent localStorage:",t.key,t.value)}catch(s){console.error("[Chat Widget] Failed to save to parent localStorage:",s)}},getFromParentStorage:t=>{var s,g;if(t!=null&&t.key&&(t!=null&&t.requestId))try{let c=localStorage.getItem(`chat_widget_${t.key}`);(s=o.contentWindow)==null||s.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:c},e.serverUrl||"*"),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Retrieved from parent localStorage:",t.key,c)}catch(c){console.error("[Chat Widget] Failed to read from parent localStorage:",c),(g=o.contentWindow)==null||g.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:null},e.serverUrl||"*")}},removeFromParentStorage:t=>{if(t!=null&&t.key)try{localStorage.removeItem(`chat_widget_${t.key}`),(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Removed from parent localStorage:",t.key)}catch(s){console.error("[Chat Widget] Failed to remove from parent localStorage:",s)}},analytics:t=>{!i.optedOut&&typeof window.gtag=="function"&&(t!=null&&t.event)&&window.gtag("event",t.event,{event_category:"Chat Widget",event_label:t.label,value:t.value})},privacy:t=>{let s=t==null?void 0:t.action;s&&a[s]&&a[s](t)},ready:()=>{(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:t=>{t!=null&&t.message&&console.error("[Chat Widget] Widget error:",t.message)}};window.addEventListener("message",t=>{let s=window.location.origin,g=e.serverUrl?new URL(e.serverUrl).origin:s;if(!(t.origin===s||t.origin===g)){console.warn("[ChatWidget] Blocked message from untrusted origin:",t.origin);return}let u=t.data;if(!u||typeof u.type!="string")return;let m=n[u.type];m&&m(u)})}function $(r,o,i,e){let a=r.serverUrl||window.location.origin;window.ChatWidget={open(){var n;(n=o.contentWindow)==null||n.postMessage({type:"open"},a)},close(){var n;(n=o.contentWindow)==null||n.postMessage({type:"close"},a)},sendMessage(n){var t;(t=o.contentWindow)==null||t.postMessage({type:"message",message:n},a)},updateContext(n){var t;(t=o.contentWindow)==null||t.postMessage({type:"updateContext",userData:n==null?void 0:n.userData,cartData:n==null?void 0:n.cartData,pageContext:n==null?void 0:n.pageContext},a)},privacy:{optOut(){y({...i,optedOut:!0}),o.remove()},optIn(){y({...i,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(C),sessionStorage.clear()},getStatus(){return b()}},version:e}}var O="2.2.1762815817",M="chat_widget_last_cleanup";function l(r,o){window.ChatWidgetDebug&&console.debug("[Chat Widget]",r,o||"")}function h(r,o){window.ChatWidgetDebug&&console.error("[Chat Widget]",r,o||"")}function A(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function N(r,o){let i=window.location.hostname;if(i&&i!==""&&i!=="localhost")return l("Domain resolved from window.location.hostname",i),i;if(o.domain)return l("Domain resolved from userConfig.domain",o.domain),o.domain;if(o.storeDomain)return l("Domain resolved from userConfig.storeDomain",o.storeDomain),o.storeDomain;if(r.domain)return l("Domain resolved from config.domain",r.domain),r.domain;if(r.storeDomain)return l("Domain resolved from config.storeDomain",r.storeDomain),r.storeDomain;try{if(document.referrer){let e=new URL(document.referrer).hostname;if(e&&e!==""&&e!=="localhost")return l("Domain resolved from document.referrer",e),e}}catch(e){h("Unable to parse referrer for domain resolution",e)}try{if(window.parent&&window.parent!==window){let e=window.parent.location.hostname;if(e&&e!==""&&e!=="localhost")return l("Domain resolved from parent window",e),e}}catch(e){l("Unable to access parent window (likely cross-origin)",e)}return h("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:r.domain||r.storeDomain,userConfigDomain:o.domain||o.storeDomain}),null}function B(r,o,i){var s;if(!r.privacy.retentionDays)return;let e=localStorage.getItem(i),a=Date.now(),n=1440*60*1e3,t=e?Number(e):0;(!t||a-t>n)&&((s=o.contentWindow)==null||s.postMessage({type:"cleanup",retentionDays:r.privacy.retentionDays},r.serverUrl||window.location.origin),localStorage.setItem(i,String(a)))}function I(r){let o=(r||"").trim();if(!o)return[];let i=[],e=a=>{a&&!i.includes(a)&&i.push(a)};try{let a=new URL(o),n=a.hostname.replace(/^www\./,""),t=n==="localhost"||n==="127.0.0.1";if(!t&&!a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";e(`${a.protocol}//www.${n}${s}`)}if(e(a.origin),!t&&a.hostname.startsWith("www.")){let s=a.port?`:${a.port}`:"";e(`${a.protocol}//${n}${s}`)}}catch(a){let n=o.replace(/\/$/,"");e(n),n.includes("://")||e(`https://www.${n.replace(/^www\./,"")}`)}return i}async function V(r,o={},i){if(!i)return fetch(r,o);let e=new AbortController,a=setTimeout(()=>e.abort(),i);try{return await fetch(r,{...o,signal:e.signal})}finally{clearTimeout(a)}}async function D(r,o,i={}){var n,t;let e=(n=i.retryDelaysMs)!=null?n:[0],a=null;for(let s of r)for(let g of e){g&&await new Promise(c=>setTimeout(c,g));try{let c=await V(`${s}${o}`,i.init,(t=i.timeoutMs)!=null?t:8e3);if(!c.ok){a=new Error(`Request failed with status ${c.status}`);continue}return{data:i.parser?await i.parser(c):c,origin:s}}catch(c){a=c}}throw a instanceof Error?a:new Error("Failed to fetch from any candidate origin")}async function z(r,o,i){let e=I(r.serverUrl);if(!e.length)return l("No server URL candidates available for remote config"),r;if(!o)return l("No domain resolved - skipping remote config fetch (will use defaults)"),r;try{let a=new URLSearchParams({domain:o}),{data:n,origin:t}=await D(e,`/api/widget/config?${a.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(n!=null&&n.success&&n.config){let s=W(r,n.config,i);return s.serverUrl=t,l("Loaded remote widget config",n.config),s}}catch(a){h("Remote config fetch failed",a)}return r}async function H(r,o){var a,n;let i=I(r.serverUrl);if(l("[Bundle Load] Candidates:",i),!i.length)throw new Error("No server URL candidates were provided");let e=await D(i,`/widget-bundle.js?v=${o}`,{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:t=>t.text()});return l("[Bundle Load] Fetched from:",e.origin),l("[Bundle Load] Code length:",((a=e.data)==null?void 0:a.length)||0),l("[Bundle Load] Code preview:",((n=e.data)==null?void 0:n.substring(0,100))||"EMPTY"),{code:e.data,origin:e.origin}}async function q(r,o){try{let i=I(r.serverUrl),{data:e}=await D(i,`/api/widget/config?id=${encodeURIComponent(o)}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:a=>a.json()});if(e!=null&&e.success&&e.config)return l("[Initialize] Config loaded successfully by app_id"),e.config}catch(i){h("[Initialize] Failed to load config by app_id",i)}return null}async function G(){var r,o;console.log("[Chat Widget] Initialize function called");try{let i=window.ChatWidgetConfig||{};console.log("[Chat Widget] User config:",i);let e=R(i);if(console.log("[Chat Widget] Created config:",e),!e.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}console.log("[Chat Widget] serverUrl configured:",e.serverUrl);let a=document.getElementById("chat-widget-iframe");if(a){let d=localStorage.getItem("omniops_ui_language"),p=JSON.stringify({domain:e.domain,serverUrl:e.serverUrl,language:d});if(window._lastWidgetConfig===p){l("Widget already loaded with identical config, skipping initialization");return}l("Widget config changed, removing old iframe and reinitializing"),a.remove()}let n=localStorage.getItem("omniops_ui_language");if(!n){let d=navigator.language||((r=navigator.languages)==null?void 0:r[0])||"en",p=d.substring(0,2).toLowerCase();console.log(`[Chat Widget] Detected browser locale: ${d}, using language: ${p}`),localStorage.setItem("omniops_ui_language",p),n=p}window._lastWidgetConfig=JSON.stringify({domain:e.domain,serverUrl:e.serverUrl,language:n});let t=b();if(t.optedOut&&e.privacy.allowOptOut){l("User has opted out of the widget");return}let s=N(e,i);s&&!e.storeDomain&&(e.storeDomain=s);let g=document.currentScript||document.querySelector('script[src*="embed.js"]'),c=g==null?void 0:g.getAttribute("data-demo");if(!i.skipRemoteConfig){let d=i.appId||(g==null?void 0:g.getAttribute("data-app-id"));if(d){l("[Initialize] Loading config by app_id:",d);let p=await q(e,d);p&&(e=W(e,p,i))}else s?e=await z(e,s,i):l("Skipping remote config fetch; neither app_id nor domain available")}let u=e.storeDomain||s||"";!e.storeDomain&&u&&(e.storeDomain=u);let{code:m,origin:Y}=await H(e,O);l("[Initialize] Bundle loaded from:",Y),l("[Initialize] API calls will go to:",e.serverUrl),l("[Initialize] Bundle code length:",(m==null?void 0:m.length)||0),l("[Initialize] Creating iframe with bundle...");let f=F(e,A()),w=L(e,t,m,u,c||null);l("[Initialize] Generated iframe HTML length:",(w==null?void 0:w.length)||0),l("[Initialize] Bundle in HTML?",w!=null&&w.includes("OmniopsWidget")?"YES":"NO"),f.srcdoc=w;let j=navigator.language||((o=navigator.languages)==null?void 0:o[0])||"en";f.setAttribute("data-locale",j),document.body.appendChild(f),f.onload=()=>{f.style.display="block",setTimeout(()=>{var E;let d=localStorage.getItem("chat_widget_session_id"),p=localStorage.getItem("chat_widget_conversation_id"),P=localStorage.getItem("chat_widget_widget_open");(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initializing with stored data:",{session_id:d,conversation_id:p,widget_open:P}),(E=f.contentWindow)==null||E.postMessage({type:"init",config:e,privacyPrefs:t,storedData:{sessionId:d,conversationId:p,widgetOpen:P==="true"}},e.serverUrl||window.location.origin)},100)},T({iframe:f,privacyPrefs:t,config:e}),$(e,f,t,O),B(e,f,M)}catch(i){h("Failed to initialize chat widget",i)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",G,{once:!0}):G();})();
