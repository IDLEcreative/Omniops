"use strict";(()=>{function b(o){return o&&o.includes("omniops.co.uk")&&!o.includes("www.omniops.co.uk")?o.replace("omniops.co.uk","www.omniops.co.uk"):o}var w={serverUrl:"https://www.omniops.co.uk",appearance:{position:"bottom-right",width:400,height:600,showPulseAnimation:!0,showNotificationBadge:!0,startMinimized:!0},features:{},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"Assistant",avatarUrl:"",showAvatar:!0,showTypingIndicator:!0,autoOpen:!1,openDelay:3e3,minimizable:!0,soundNotifications:!1,persistConversation:!0,messageDelay:500},privacy:{allowOptOut:!0,showPrivacyNotice:!0,requireConsent:!1,retentionDays:30},userData:null,pageContext:null,cartData:null,orderContext:null,woocommerceEnabled:!1,storeDomain:null,debug:!1};function I(o,e){return{...o,...e||{}}}function D(o,e){return{...o,...e||{}}}function P(o,e){return{...o,...e||{}}}function O(o={}){let e={...o,serverUrl:o.serverUrl?b(o.serverUrl):void 0};return{...w,...e,appearance:I(w.appearance,o.appearance),behavior:D(w.behavior,o.behavior),features:P(w.features,o.features),privacy:{...w.privacy,...o.privacy||{}}}}function h(o,e,i={}){var n,a;if(!e)return{...o,serverUrl:b(o.serverUrl)};let r={...o,woocommerceEnabled:e.woocommerce_enabled||o.woocommerceEnabled};return r.appearance=I(I(r.appearance,e.appearance||void 0),i.appearance),r.behavior=D(D(r.behavior,e.behavior||void 0),i.behavior),r.features=P(P(r.features,e.features||void 0),i.features),e.domain&&(r.storeDomain=e.domain),e.branding&&(e.branding.primary_color&&!((n=i.appearance)!=null&&n.primaryColor)&&(r.appearance.primaryColor=e.branding.primary_color||r.appearance.primaryColor),e.branding.welcome_message&&!((a=i.behavior)!=null&&a.welcomeMessage)&&(r.behavior.welcomeMessage=e.branding.welcome_message||r.behavior.welcomeMessage)),r.serverUrl=b(r.serverUrl),r}var y="chat_widget_privacy",S={optedOut:!1,consentGiven:!1};function v(){try{let o=localStorage.getItem(y);if(!o)return{...S};let e=JSON.parse(o);return{optedOut:!!(e!=null&&e.optedOut),consentGiven:!!(e!=null&&e.consentGiven)}}catch(o){return{...S}}}function f(o){try{localStorage.setItem(y,JSON.stringify(o))}catch(e){}}function E(o,e){var s,g,l;let i=document.createElement("iframe");i.id="chat-widget-iframe",i.title="Customer Support Chat",i.setAttribute("scrolling","no");let r=(s=o.appearance.startMinimized)!=null?s:!0,n=r&&!e?64:o.appearance.width||400,a=r&&!e?64:o.appearance.height||600,t=["position: fixed",e?"bottom: 0":(g=o.appearance.position)!=null&&g.includes("bottom")?"bottom: 20px":"top: 20px",e?"right: 0":(l=o.appearance.position)!=null&&l.includes("right")?"right: 20px":"left: 20px",e?"left: 0":"","border: none",`width: ${e?"100vw":n+"px"}`,`height: ${e?"100vh":a+"px"}`,`max-width: ${e?"100vw":"calc(100vw - 40px)"}`,`max-height: ${e?"100vh":"calc(100vh - 40px)"}`,"z-index: 9999",`border-radius: ${e||r?"0":o.appearance.borderRadius||"12px"}`,"box-shadow: none","background: transparent","overflow: hidden"].filter(Boolean);return i.style.cssText=`${t.join("; ")};`,i.style.display="none",i.style.pointerEvents="none",i}function R(o,e,i,r,n){(window.ChatWidgetDebug||o.debug)&&(console.debug("[buildIframeHtml] Received bundleCode length:",(i==null?void 0:i.length)||0),console.debug("[buildIframeHtml] BundleCode preview:",(i==null?void 0:i.substring(0,100))||"EMPTY"),console.debug("[buildIframeHtml] Domain:",r));let a={...o,domain:r,demoId:n,privacySettings:{allowOptOut:o.privacy.allowOptOut,showPrivacyNotice:o.privacy.showPrivacyNotice,requireConsent:o.privacy.requireConsent,consentGiven:e.consentGiven,retentionDays:o.privacy.retentionDays}},s=['<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Chat Widget</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden;background:transparent}#widget-root{width:100%;height:100%;position:fixed;inset:0;overflow:hidden;background:transparent}</style></head><body><div id="widget-root"></div><script>',`window.__WIDGET_CONFIG__=${JSON.stringify(a)};`,i,'const initFn=window.OmniopsWidget?.initWidget||window.OmniopsWidgetBundle?.initWidget;if(initFn){initFn("widget-root",window.__WIDGET_CONFIG__);}else{console.error("[Chat Widget] Widget bundle did not expose initWidget function");}<\/script></body></html>'].join("");return(window.ChatWidgetDebug||o.debug)&&(console.debug("[buildIframeHtml] Final HTML length:",s.length),console.debug("[buildIframeHtml] Contains OmniopsWidget?",s.includes("OmniopsWidget"))),s}function k(o){let{iframe:e,privacyPrefs:i,config:r}=o,n={optOut:()=>{f({...i,optedOut:!0}),e.remove()},optIn:()=>{f({...i,optedOut:!1})},giveConsent:()=>f({...i,consentGiven:!0}),requestDataExport:t=>{t!=null&&t.userId&&window.open(`${r.serverUrl}/privacy/export?user=${t.userId}`,"_blank")},requestDataDeletion:t=>{t!=null&&t.userId&&confirm("Are you sure you want to delete all your chat data? This cannot be undone.")&&fetch(`${r.serverUrl}/api/privacy/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t.userId})})}},a={ping:t=>{var s;t!=null&&t.pingTime&&((s=e.contentWindow)==null||s.postMessage({type:"pong",pingTime:t.pingTime},r.serverUrl||"*"))},resize:t=>{typeof(t==null?void 0:t.width)=="number"&&(e.style.width=`${t.width}px`),typeof(t==null?void 0:t.height)=="number"&&(e.style.height=`${t.height}px`)},widgetOpened:()=>{e.style.pointerEvents="auto"},widgetClosed:()=>{e.style.pointerEvents="none"},saveToParentStorage:t=>{if(t!=null&&t.key&&(t==null?void 0:t.value)!==void 0)try{localStorage.setItem(`chat_widget_${t.key}`,t.value),(r.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Saved to parent localStorage:",t.key,t.value)}catch(s){console.error("[Chat Widget] Failed to save to parent localStorage:",s)}},getFromParentStorage:t=>{var s,g;if(t!=null&&t.key&&(t!=null&&t.requestId))try{let l=localStorage.getItem(`chat_widget_${t.key}`);(s=e.contentWindow)==null||s.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:l},r.serverUrl||"*"),(r.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Retrieved from parent localStorage:",t.key,l)}catch(l){console.error("[Chat Widget] Failed to read from parent localStorage:",l),(g=e.contentWindow)==null||g.postMessage({type:"storageResponse",requestId:t.requestId,key:t.key,value:null},r.serverUrl||"*")}},removeFromParentStorage:t=>{if(t!=null&&t.key)try{localStorage.removeItem(`chat_widget_${t.key}`),(r.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Removed from parent localStorage:",t.key)}catch(s){console.error("[Chat Widget] Failed to remove from parent localStorage:",s)}},analytics:t=>{!i.optedOut&&typeof window.gtag=="function"&&(t!=null&&t.event)&&window.gtag("event",t.event,{event_category:"Chat Widget",event_label:t.label,value:t.value})},privacy:t=>{let s=t==null?void 0:t.action;s&&n[s]&&n[s](t)},ready:()=>{(r.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Widget ready")},error:t=>{t!=null&&t.message&&console.error("[Chat Widget] Widget error:",t.message)}};window.addEventListener("message",t=>{let s=window.location.origin,g=r.serverUrl?new URL(r.serverUrl).origin:s;if(!(t.origin===s||t.origin===g)){console.warn("[ChatWidget] Blocked message from untrusted origin:",t.origin);return}let d=t.data;if(!d||typeof d.type!="string")return;let p=a[d.type];p&&p(d)})}function F(o,e,i,r){let n=o.serverUrl||window.location.origin;window.ChatWidget={open(){var a;(a=e.contentWindow)==null||a.postMessage({type:"open"},n)},close(){var a;(a=e.contentWindow)==null||a.postMessage({type:"close"},n)},sendMessage(a){var t;(t=e.contentWindow)==null||t.postMessage({type:"message",message:a},n)},updateContext(a){var t;(t=e.contentWindow)==null||t.postMessage({type:"updateContext",userData:a==null?void 0:a.userData,cartData:a==null?void 0:a.cartData,pageContext:a==null?void 0:a.pageContext},n)},privacy:{optOut(){f({...i,optedOut:!0}),e.remove()},optIn(){f({...i,optedOut:!1}),window.location.reload()},clearData(){localStorage.removeItem(y),sessionStorage.clear()},getStatus(){return v()}},version:r}}var _="2.2.1762813322",T="chat_widget_last_cleanup";function c(o,e){window.ChatWidgetDebug&&console.debug("[Chat Widget]",o,e||"")}function u(o,e){window.ChatWidgetDebug&&console.error("[Chat Widget]",o,e||"")}function M(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||window.innerWidth<=768}function $(o,e){let i=window.location.hostname;if(i&&i!==""&&i!=="localhost")return c("Domain resolved from window.location.hostname",i),i;if(e.domain)return c("Domain resolved from userConfig.domain",e.domain),e.domain;if(e.storeDomain)return c("Domain resolved from userConfig.storeDomain",e.storeDomain),e.storeDomain;if(o.domain)return c("Domain resolved from config.domain",o.domain),o.domain;if(o.storeDomain)return c("Domain resolved from config.storeDomain",o.storeDomain),o.storeDomain;try{if(document.referrer){let r=new URL(document.referrer).hostname;if(r&&r!==""&&r!=="localhost")return c("Domain resolved from document.referrer",r),r}}catch(r){u("Unable to parse referrer for domain resolution",r)}try{if(window.parent&&window.parent!==window){let r=window.parent.location.hostname;if(r&&r!==""&&r!=="localhost")return c("Domain resolved from parent window",r),r}}catch(r){c("Unable to access parent window (likely cross-origin)",r)}return u("Unable to resolve domain from any source",{location:window.location.hostname,referrer:document.referrer,configDomain:o.domain||o.storeDomain,userConfigDomain:e.domain||e.storeDomain}),null}function A(o,e,i){var s;if(!o.privacy.retentionDays)return;let r=localStorage.getItem(i),n=Date.now(),a=1440*60*1e3,t=r?Number(r):0;(!t||n-t>a)&&((s=e.contentWindow)==null||s.postMessage({type:"cleanup",retentionDays:o.privacy.retentionDays},o.serverUrl||window.location.origin),localStorage.setItem(i,String(n)))}function W(o){let e=(o||"").trim();if(!e)return[];let i=[],r=n=>{n&&!i.includes(n)&&i.push(n)};try{let n=new URL(e),a=n.hostname.replace(/^www\./,""),t=a==="localhost"||a==="127.0.0.1";if(!t&&!n.hostname.startsWith("www.")){let s=n.port?`:${n.port}`:"";r(`${n.protocol}//www.${a}${s}`)}if(r(n.origin),!t&&n.hostname.startsWith("www.")){let s=n.port?`:${n.port}`:"";r(`${n.protocol}//${a}${s}`)}}catch(n){let a=e.replace(/\/$/,"");r(a),a.includes("://")||r(`https://www.${a.replace(/^www\./,"")}`)}return i}async function H(o,e={},i){if(!i)return fetch(o,e);let r=new AbortController,n=setTimeout(()=>r.abort(),i);try{return await fetch(o,{...e,signal:r.signal})}finally{clearTimeout(n)}}async function C(o,e,i={}){var a,t;let r=(a=i.retryDelaysMs)!=null?a:[0],n=null;for(let s of o)for(let g of r){g&&await new Promise(l=>setTimeout(l,g));try{let l=await H(`${s}${e}`,i.init,(t=i.timeoutMs)!=null?t:8e3);if(!l.ok){n=new Error(`Request failed with status ${l.status}`);continue}return{data:i.parser?await i.parser(l):l,origin:s}}catch(l){n=l}}throw n instanceof Error?n:new Error("Failed to fetch from any candidate origin")}async function L(o,e,i){let r=W(o.serverUrl);if(!r.length)return c("No server URL candidates available for remote config"),o;if(!e)return c("No domain resolved - skipping remote config fetch (will use defaults)"),o;try{let n=new URLSearchParams({domain:e}),{data:a,origin:t}=await C(r,`/api/widget/config?${n.toString()}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:s=>s.json()});if(a!=null&&a.success&&a.config){let s=h(o,a.config,i);return s.serverUrl=t,c("Loaded remote widget config",a.config),s}}catch(n){u("Remote config fetch failed",n)}return o}async function B(o,e){var n,a;let i=W(o.serverUrl);if(c("[Bundle Load] Candidates:",i),!i.length)throw new Error("No server URL candidates were provided");let r=await C(i,`/widget-bundle.js?v=${e}`,{timeoutMs:8e3,retryDelaysMs:[0,500,1500],parser:t=>t.text()});return c("[Bundle Load] Fetched from:",r.origin),c("[Bundle Load] Code length:",((n=r.data)==null?void 0:n.length)||0),c("[Bundle Load] Code preview:",((a=r.data)==null?void 0:a.substring(0,100))||"EMPTY"),{code:r.data,origin:r.origin}}async function N(o,e){try{let i=W(o.serverUrl),{data:r}=await C(i,`/api/widget/config?id=${encodeURIComponent(e)}`,{timeoutMs:8e3,retryDelaysMs:[0,500],parser:n=>n.json()});if(r!=null&&r.success&&r.config)return c("[Initialize] Config loaded successfully by app_id"),r.config}catch(i){u("[Initialize] Failed to load config by app_id",i)}return null}async function z(){console.log("[Chat Widget] Initialize function called");try{let o=window.ChatWidgetConfig||{};console.log("[Chat Widget] User config:",o);let e=O(o);if(console.log("[Chat Widget] Created config:",e),!e.serverUrl){console.error("[Chat Widget] serverUrl not configured. Please ensure window.ChatWidgetConfig includes a serverUrl.");return}if(console.log("[Chat Widget] serverUrl configured:",e.serverUrl),document.getElementById("chat-widget-iframe")){u("Widget already loaded");return}let i=v();if(i.optedOut&&e.privacy.allowOptOut){c("User has opted out of the widget");return}let r=$(e,o);r&&!e.storeDomain&&(e.storeDomain=r);let n=document.currentScript||document.querySelector('script[src*="embed.js"]'),a=n==null?void 0:n.getAttribute("data-demo");if(!o.skipRemoteConfig){let p=o.appId||(n==null?void 0:n.getAttribute("data-app-id"));if(p){c("[Initialize] Loading config by app_id:",p);let m=await N(e,p);m&&(e=h(e,m,o))}else r?e=await L(e,r,o):c("Skipping remote config fetch; neither app_id nor domain available")}let t=e.storeDomain||r||"";!e.storeDomain&&t&&(e.storeDomain=t);let{code:s,origin:g}=await B(e,_);c("[Initialize] Bundle loaded from:",g),c("[Initialize] API calls will go to:",e.serverUrl),c("[Initialize] Bundle code length:",(s==null?void 0:s.length)||0),c("[Initialize] Creating iframe with bundle...");let l=E(e,M()),d=R(e,i,s,t,a||null);c("[Initialize] Generated iframe HTML length:",(d==null?void 0:d.length)||0),c("[Initialize] Bundle in HTML?",d!=null&&d.includes("OmniopsWidget")?"YES":"NO"),l.srcdoc=d,document.body.appendChild(l),l.onload=()=>{l.style.display="block",setTimeout(()=>{var x;let p=localStorage.getItem("chat_widget_session_id"),m=localStorage.getItem("chat_widget_conversation_id"),U=localStorage.getItem("chat_widget_widget_open");(e.debug||window.ChatWidgetDebug)&&console.log("[Chat Widget] Initializing with stored data:",{session_id:p,conversation_id:m,widget_open:U}),(x=l.contentWindow)==null||x.postMessage({type:"init",config:e,privacyPrefs:i,storedData:{sessionId:p,conversationId:m,widgetOpen:U==="true"}},e.serverUrl||window.location.origin)},100)},k({iframe:l,privacyPrefs:i,config:e}),F(e,l,i,_),A(e,l,T)}catch(o){u("Failed to initialize chat widget",o)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",z,{once:!0}):z();})();
